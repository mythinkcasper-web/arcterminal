<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARC Lojistik v6</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0f172a; color: #fff; height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; user-select: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* KAMERA VE VİZÖR */
        #scanner-container { position: fixed; inset: 0; z-index: 50; background: #000; display: none; }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

        .scan-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 60;
            background: rgba(0, 0, 0, 0.7);
            -webkit-mask: radial-gradient(transparent 140px, black 141px);
            mask: radial-gradient(transparent 140px, black 141px);
        }

        .focus-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 280px; border: 2px solid rgba(255,255,255,0.2); border-radius: 20px; z-index: 70;
        }
        
        .corner { position: absolute; width: 30px; height: 30px; border: 4px solid; transition: 0.3s; }
        .tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; border-radius: 16px 0 0 0; }
        .tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; border-radius: 0 16px 0 0; }
        .bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; border-radius: 0 0 0 16px; }
        .br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; border-radius: 0 0 16px 0; }

        .mode-in .corner { border-color: #10b981; }
        .mode-out .corner { border-color: #f43f5e; }

        .laser-line {
            position: absolute; top: 50%; left: 5%; width: 90%; height: 2px;
            background: currentColor; box-shadow: 0 0 15px currentColor;
            animation: scan 1.5s infinite ease-in-out;
        }
        @keyframes scan { 0%, 100% { top: 10%; opacity: 0; } 50% { opacity: 1; } 100% { top: 90%; opacity: 0; } }

    </style>
</head>
<body class="flex flex-col h-full bg-slate-900">

    <!-- HEADER -->
    <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center z-20 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold text-lg">
                <i class="fas fa-dolly"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-100 text-sm tracking-wide">ARC LOJİSTİK</h1>
                <div class="text-[10px] text-slate-400 font-mono" id="clock">GS1 READY</div>
            </div>
        </div>
        <div class="bg-slate-800 px-3 py-1 rounded border border-slate-600">
            <div class="text-[10px] text-slate-500">KULLANICI</div>
            <div class="text-xs font-bold text-blue-400">ADMIN</div>
        </div>
    </header>

    <!-- SAYFALAR -->
    <main class="flex-1 overflow-y-auto relative no-scrollbar pb-20">
        
        <!-- DASHBOARD -->
        <div id="page-home" class="p-4 space-y-4 fade-in">
            
            <!-- GİRİŞ BUTONU -->
            <button onclick="startScanner('IN')" class="w-full bg-slate-800 hover:bg-slate-700 active:scale-[0.98] transition-all p-6 rounded-2xl border-l-4 border-emerald-500 shadow-lg relative overflow-hidden group">
                <div class="relative z-10 flex justify-between items-center">
                    <div class="text-left">
                        <div class="text-xs font-bold text-emerald-500 mb-1">DEPO GİRİŞİ</div>
                        <h2 class="text-2xl font-bold text-white">MAL KABUL</h2>
                        <p class="text-[10px] text-slate-400">GS1 / QR / Barkod</p>
                    </div>
                    <i class="fas fa-box-open text-3xl text-emerald-500/50 group-hover:scale-110 transition"></i>
                </div>
            </button>

            <!-- ÇIKIŞ BUTONU -->
            <button onclick="startScanner('OUT')" class="w-full bg-slate-800 hover:bg-slate-700 active:scale-[0.98] transition-all p-6 rounded-2xl border-l-4 border-rose-500 shadow-lg relative overflow-hidden group">
                <div class="relative z-10 flex justify-between items-center">
                    <div class="text-left">
                        <div class="text-xs font-bold text-rose-500 mb-1">SEVKİYAT</div>
                        <h2 class="text-2xl font-bold text-white">ÇIKIŞ YAP</h2>
                        <p class="text-[10px] text-slate-400">Stoktan Düş</p>
                    </div>
                    <i class="fas fa-truck-loading text-3xl text-rose-500/50 group-hover:scale-110 transition"></i>
                </div>
            </button>

            <!-- ÖZET TABLOSU -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
                <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase">Toplu Stok Durumu</h3>
                <div id="summary-list" class="space-y-3">
                    <!-- Ürünlerin toplam adetleri burada gruplanacak -->
                    <div class="text-center text-xs text-slate-600">Veri yok</div>
                </div>
            </div>

        </div>

        <!-- STOK DETAYI -->
        <div id="page-stocks" class="hidden p-4 space-y-4">
            <input type="text" id="search-input" onkeyup="renderStocks()" placeholder="Ref No, GTIN veya İsim..." class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-blue-500 outline-none text-sm">
            <div id="stock-list" class="grid grid-cols-1 gap-3 pb-20"></div>
        </div>

    </main>

    <!-- NAVBAR -->
    <nav class="bg-slate-900 border-t border-slate-800 h-16 flex z-30">
        <button onclick="switchPage('home')" class="flex-1 flex flex-col items-center justify-center text-blue-500 nav-btn active">
            <i class="fas fa-home text-lg"></i>
            <span class="text-[10px] font-bold mt-1">ANA EKRAN</span>
        </button>
        <button onclick="switchPage('stocks')" class="flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-slate-300 nav-btn">
            <i class="fas fa-boxes text-lg"></i>
            <span class="text-[10px] font-bold mt-1">STOKLAR</span>
        </button>
        <button onclick="exportExcel()" class="flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-slate-300 nav-btn">
            <i class="fas fa-file-csv text-lg"></i>
            <span class="text-[10px] font-bold mt-1">RAPOR</span>
        </button>
    </nav>

    <!-- KAMERA UI -->
    <div id="scanner-container">
        <div id="reader"></div>
        <div class="scan-overlay"></div>
        
        <div id="focus-frame" class="focus-box text-white">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
            <div class="laser-line"></div>
        </div>

        <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-[100]">
            <div class="bg-black/60 backdrop-blur px-3 py-1 rounded border border-white/20">
                <div class="text-[10px] text-slate-300 font-bold" id="cam-mode">MOD</div>
                <div class="text-lg font-bold text-white tracking-widest">TARAMA</div>
            </div>
            <button onclick="stopScanner()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white"><i class="fas fa-times"></i></button>
        </div>

        <!-- Zoom Slider -->
        <div class="absolute bottom-10 left-0 w-full px-10 z-[100]">
            <div class="flex justify-between text-xs text-white/70 font-bold mb-1"><span>1x</span><span>ZOOM</span><span>4x</span></div>
            <input type="range" min="1" max="4" step="0.1" value="1" oninput="applyZoom(this.value)" class="w-full h-1 bg-white/30 rounded-lg appearance-none cursor-pointer">
        </div>
    </div>

    <!-- HATA POPUP (DUPLICATE) -->
    <div id="error-modal" class="fixed inset-0 z-[150] hidden bg-black/90 backdrop-blur flex items-center justify-center p-6">
        <div class="bg-slate-800 border border-red-500 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl shadow-red-900/50">
            <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Mükerrer Okuma!</h3>
            <p class="text-sm text-slate-300 mb-4">Bu seri numaralı ürün (SN) zaten sisteme işlenmiş.</p>
            <div class="bg-black/30 p-2 rounded mb-4 font-mono text-red-400 text-sm" id="err-sn">---</div>
            <button onclick="closeError()" class="w-full py-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-white">TAMAM</button>
        </div>
    </div>

    <!-- ÜRÜN ONAY POPUP -->
    <div id="product-modal" class="fixed inset-0 z-[120] hidden bg-black/90 backdrop-blur flex items-end sm:items-center justify-center">
        <div class="bg-slate-800 w-full sm:w-[450px] rounded-t-3xl sm:rounded-2xl border-t border-slate-600 shadow-2xl p-6 animate-up">
            
            <div class="w-12 h-1 bg-slate-600 rounded-full mx-auto mb-4 opacity-50 sm:hidden"></div>

            <!-- Parsellenmiş Veri Kartı -->
            <div class="bg-slate-900 rounded-xl border border-slate-700 p-4 mb-4 relative">
                <div class="text-[10px] text-slate-500 font-bold mb-2 flex justify-between">
                    <span>TESPİT EDİLEN VERİLER</span>
                    <span id="modal-gtin" class="text-blue-400 font-mono">GTIN: ---</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-500">REF NO</div>
                        <div class="font-bold text-white font-mono" id="modal-ref">---</div>
                    </div>
                    <div class="bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-500">LOT</div>
                        <div class="font-bold text-white font-mono" id="modal-lot">---</div>
                    </div>
                </div>
                <div class="bg-slate-800 p-2 rounded border border-slate-700 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-slate-500">SERİ NO (SN)</div>
                        <div class="font-bold text-emerald-400 font-mono tracking-wide" id="modal-sn">---</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-500">SKT</div>
                        <div class="font-bold text-white font-mono" id="modal-exp">---</div>
                    </div>
                </div>
            </div>

            <!-- Ürün Tanımı -->
            <div class="flex gap-4 mb-4">
                <div class="w-20 h-20 bg-slate-700 rounded-lg flex-none overflow-hidden relative">
                    <img id="modal-img" src="" class="w-full h-full object-cover hidden">
                    <label class="absolute inset-0 flex items-center justify-center cursor-pointer text-slate-500 hover:text-white transition">
                        <i class="fas fa-camera text-xl"></i>
                        <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this)">
                    </label>
                </div>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 font-bold">ÜRÜN ADI</label>
                    <input type="text" id="modal-name" placeholder="Ürün İsmi..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none mt-1">
                    <div class="text-[10px] text-blue-400 mt-2 font-bold" id="modal-total-stock">TOPLAM STOK: 0 ADET</div>
                </div>
            </div>

            <!-- Aksiyon -->
            <button onclick="saveProduct()" id="save-btn" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white shadow-lg text-lg tracking-wide">
                KAYDET
            </button>
            <button onclick="closeProductModal()" class="w-full py-3 text-slate-500 text-xs font-bold mt-2">İPTAL</button>
        </div>
    </div>

    <script>
        // --- ARC v6 GS1 ENGINE ---
        
        const DB_KEY = 'arc_gs1_db';
        // Yapı:
        // products: { "GTIN_VEYA_REF": { name, image, totalQty, logs: [ {sn, lot, exp, date, type} ] } }
        let db = { products: {} }; 

        let html5QrCode;
        let scanMode = 'IN';
        let parsedData = {}; // Okunan veriler buraya

        function init() {
            const data = localStorage.getItem(DB_KEY);
            if(data) db = JSON.parse(data);
            updateDashboard();
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            updateDashboard();
        }

        // --- GS1 PARSER (ÖZEL PARÇALAYICI) ---
        function parseBarcode(rawText) {
            // Ham Metin: 01 8699015280174 17 280205 10 P110 240 A3920 21 000212
            // Boşluklara göre veya AI tanımlarına göre ayıracağız.
            
            let result = {
                raw: rawText,
                gtin: "",
                lot: "",
                ref: "",
                sn: "",
                exp: "",
                id: rawText // Varsayılan ID (Bütün metin)
            };

            // Eğer boşluklu yapı varsa (Senin örneğin)
            if(rawText.includes(' ')) {
                const parts = rawText.split(' ');
                for(let i=0; i<parts.length; i++) {
                    if(parts[i] === '01' && parts[i+1]) result.gtin = parts[i+1];
                    if(parts[i] === '17' && parts[i+1]) result.exp = parts[i+1];
                    if(parts[i] === '10' && parts[i+1]) result.lot = parts[i+1];
                    if(parts[i] === '240' && parts[i+1]) result.ref = parts[i+1];
                    if(parts[i] === '21' && parts[i+1]) result.sn = parts[i+1];
                }
            } 
            // Eğer boşluksuz standart GS1 ise (Regex denemesi - Basit)
            else {
                // Basit fallback: Eğer parse edilemiyorsa tümünü SN kabul et
                result.sn = rawText;
            }

            // Ana Kimlik Belirleme (Ürünleri neye göre gruplayacağız?)
            // Öncelik: GTIN -> REF -> RAW
            if(result.gtin) result.id = result.gtin;
            else if(result.ref) result.id = result.ref;

            return result;
        }

        // --- KAMERA ---
        function startScanner(mode) {
            scanMode = mode;
            document.getElementById('scanner-container').style.display = 'block';
            
            const frame = document.getElementById('focus-frame');
            const modeTxt = document.getElementById('cam-mode');
            
            if(mode === 'IN') {
                frame.className = "focus-box mode-in text-emerald-500";
                modeTxt.innerText = "GİRİŞ MODU";
                modeTxt.className = "text-[10px] text-emerald-400 font-bold";
            } else {
                frame.className = "focus-box mode-out text-rose-500";
                modeTxt.innerText = "ÇIKIŞ MODU";
                modeTxt.className = "text-[10px] text-rose-400 font-bold";
            }

            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 30, qrbox: {width: 250, height: 250}, aspectRatio: window.innerWidth/window.innerHeight };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScan).catch(err => {
                alert("Kamera hatası: "+err);
                stopScanner();
            });
        }

        function stopScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').style.display = 'none';
                    html5QrCode.clear();
                }).catch(() => { document.getElementById('scanner-container').style.display = 'none'; });
            } else {
                document.getElementById('scanner-container').style.display = 'none';
            }
        }

        function applyZoom(val) {
            if(html5QrCode) {
                try { html5QrCode.applyVideoConstraints({ advanced: [{zoom: parseFloat(val)}] }); } catch(e){}
            }
        }

        function onScan(decodedText) {
            playBeep();
            if(navigator.vibrate) navigator.vibrate(50);
            html5QrCode.pause();

            // 1. Parse Et
            parsedData = parseBarcode(decodedText);
            
            // 2. Kontrol Et (Mükerrer SN?)
            // Ürün veritabanında var mı?
            const product = db.products[parsedData.id];
            
            if(product) {
                // Bu seri numarası daha önce okutulmuş mu?
                const existingSN = product.logs.find(l => l.sn === parsedData.sn);
                
                // Eğer GİRİŞ yapıyorsak ve SN zaten varsa -> HATA
                if(scanMode === 'IN' && existingSN && parsedData.sn) {
                    showError(parsedData.sn);
                    return;
                }
                
                // Eğer ÇIKIŞ yapıyorsak ve SN yoksa -> HATA (Olmayan mal çıkamaz)
                if(scanMode === 'OUT' && !existingSN && parsedData.sn) {
                    alert("Bu seri numaralı ürün stokta yok!");
                    html5QrCode.resume();
                    return;
                }
            } else {
                // Ürün yoksa ve ÇIKIŞ ise -> HATA
                if(scanMode === 'OUT') {
                    alert("Tanımsız ürün! Çıkış yapılamaz.");
                    html5QrCode.resume();
                    return;
                }
            }

            openModal(parsedData, product);
        }

        function showError(sn) {
            document.getElementById('err-sn').innerText = "SN: " + sn;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        function closeError() {
            document.getElementById('error-modal').classList.add('hidden');
            html5QrCode.resume();
        }

        // --- MODAL ---
        function openModal(data, existingProduct) {
            const modal = document.getElementById('product-modal');
            const btn = document.getElementById('save-btn');

            // Alanları Doldur
            document.getElementById('modal-gtin').innerText = data.gtin || "---";
            document.getElementById('modal-ref').innerText = data.ref || "---";
            document.getElementById('modal-lot').innerText = data.lot || "---";
            document.getElementById('modal-sn').innerText = data.sn || "GENEL";
            
            // Tarih Formatı (YYMMDD -> DD.MM.20YY)
            let formattedExp = "---";
            if(data.exp && data.exp.length === 6) {
                formattedExp = `${data.exp.substring(4,6)}.${data.exp.substring(2,4)}.20${data.exp.substring(0,2)}`;
            }
            document.getElementById('modal-exp').innerText = formattedExp;

            // İsim ve Resim (Varsa)
            const nameInput = document.getElementById('modal-name');
            const imgEl = document.getElementById('modal-img');
            
            if(existingProduct) {
                nameInput.value = existingProduct.name;
                document.getElementById('modal-total-stock').innerText = `TOPLAM STOK: ${existingProduct.totalQty} ADET`;
                if(existingProduct.image) {
                    imgEl.src = existingProduct.image;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }
            } else {
                nameInput.value = "";
                document.getElementById('modal-total-stock').innerText = "YENİ ÜRÜN";
                imgEl.classList.add('hidden');
            }

            // Buton Ayarı
            if(scanMode === 'IN') {
                btn.innerText = "KAYDET (GİRİŞ)";
                btn.className = "w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white shadow-lg text-lg tracking-wide";
            } else {
                btn.innerText = "KAYDET (ÇIKIŞ)";
                btn.className = "w-full py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-white shadow-lg text-lg tracking-wide";
            }

            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            html5QrCode.resume();
        }

        function handlePhoto(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('modal-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProduct() {
            const name = document.getElementById('modal-name').value || "İsimsiz Ürün (" + parsedData.id + ")";
            const imgSrc = document.getElementById('modal-img').src;
            const hasImg = !document.getElementById('modal-img').classList.contains('hidden');

            // Ürünü Bul veya Oluştur
            if(!db.products[parsedData.id]) {
                db.products[parsedData.id] = {
                    id: parsedData.id,
                    name: name,
                    image: hasImg ? imgSrc : null,
                    totalQty: 0,
                    logs: []
                };
            }
            
            let prod = db.products[parsedData.id];
            
            // İsmi güncelle (belki yeni girilmiştir)
            if(name) prod.name = name;
            if(hasImg && imgSrc.startsWith('data:')) prod.image = imgSrc;

            // Log Kaydı (Her bir kutu için)
            const logEntry = {
                sn: parsedData.sn,
                lot: parsedData.lot,
                ref: parsedData.ref,
                exp: document.getElementById('modal-exp').innerText,
                date: new Date().toLocaleString('tr-TR'),
                type: scanMode
            };

            if(scanMode === 'IN') {
                prod.logs.push(logEntry);
                prod.totalQty++;
            } else {
                // Çıkışta SN'i loglardan düşürmüyoruz (kayıt kalsın), ama stoktan düşüyoruz.
                // İsterseniz SN'i "Çıkış Yapıldı" olarak işaretleyebiliriz.
                // Basitlik için stok düşüyoruz:
                prod.totalQty = Math.max(0, prod.totalQty - 1);
                
                // Çıkış logu ekle
                prod.logs.push(logEntry);
            }

            saveDB();
            document.getElementById('product-modal').classList.add('hidden');
            stopScanner();
        }

        // --- UI GÜNCELLEME ---
        function updateDashboard() {
            const list = document.getElementById('summary-list');
            const productsArr = Object.values(db.products);
            
            if(productsArr.length === 0) {
                list.innerHTML = '<div class="text-center text-xs text-slate-600">Veri yok</div>';
                return;
            }

            list.innerHTML = productsArr.map(p => `
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-800 rounded flex-none overflow-hidden">
                            ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i class="fas fa-cube"></i></div>`}
                        </div>
                        <div class="overflow-hidden">
                            <div class="text-xs font-bold text-white truncate w-40">${p.name}</div>
                            <div class="text-[10px] text-slate-500 font-mono">${p.id}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-slate-500">ADET</div>
                        <div class="text-lg font-bold ${p.totalQty > 0 ? 'text-blue-400' : 'text-red-500'}">${p.totalQty}</div>
                    </div>
                </div>
            `).join('');

            renderStocks();
        }

        function renderStocks() {
            const term = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : "";
            const grid = document.getElementById('stock-list');
            if(!grid) return;

            const productsArr = Object.values(db.products).filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.id.includes(term)
            );

            grid.innerHTML = productsArr.map(p => `
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-white text-sm">${p.name}</h4>
                            <p class="text-[10px] text-slate-400 font-mono">ID: ${p.id}</p>
                        </div>
                        <span class="text-xl font-bold text-blue-400">${p.totalQty}</span>
                    </div>
                    <div class="bg-slate-900 p-2 max-h-32 overflow-y-auto">
                        <table class="w-full text-[10px] text-left text-slate-400">
                            <thead><tr><th class="p-1">SN</th><th class="p-1">LOT</th><th class="p-1">TÜR</th></tr></thead>
                            <tbody>
                                ${p.logs.slice().reverse().map(l => `
                                    <tr class="border-b border-slate-800">
                                        <td class="p-1 font-mono text-white">${l.sn}</td>
                                        <td class="p-1">${l.lot}</td>
                                        <td class="p-1 ${l.type==='IN'?'text-emerald-500':'text-rose-500'} font-bold">${l.type==='IN'?'GİRİŞ':'ÇIKIŞ'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // SAYFA GEÇİŞ
        function switchPage(page) {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active', 'text-blue-500'));
            
            if(page === 'home') {
                document.getElementById('page-home').classList.remove('hidden');
                document.querySelectorAll('.nav-btn')[0].classList.add('active', 'text-blue-500');
            }
            if(page === 'stocks') {
                document.getElementById('page-stocks').classList.remove('hidden');
                document.querySelectorAll('.nav-btn')[1].classList.add('active', 'text-blue-500');
                renderStocks();
            }
        }

        function exportExcel() {
            let csv = "ID;URUN_ADI;ISLEM_TIPI;SERI_NO;LOT;SKT;TARIH\n";
            Object.values(db.products).forEach(p => {
                p.logs.forEach(l => {
                    csv += `${p.id};${p.name};${l.type};${l.sn};${l.lot};${l.exp};${l.date}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Lojistik_Rapor.csv'; a.click();
        }

        function playBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type='square'; o.frequency.value=1200; g.gain.value=0.1;
            o.start(); setTimeout(()=>o.stop(), 0.1);
        }

        init();
    </script>
</body>
</html>

