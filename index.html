<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARC v12 (Lot Matrix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* TEMEL AYARLAR */
        body { background-color: #0f172a; color: #fff; height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* KAMERA KATMANI */
        #scanner-container { position: fixed; inset: 0; z-index: 50; background: #000; display: none; }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

        /* MODAL KATMANI */
        .modal-layer { z-index: 200 !important; }

        /* VİZÖR */
        .scan-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 60; background: rgba(0, 0, 0, 0.6);
            -webkit-mask: radial-gradient(transparent 140px, black 141px); mask: radial-gradient(transparent 140px, black 141px);
        }
        .focus-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 280px; border: 2px solid rgba(255,255,255,0.4); border-radius: 20px; z-index: 70;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.5);
        }
        .laser {
            position: absolute; top: 50%; left: 5%; width: 90%; height: 2px;
            background: #ef4444; box-shadow: 0 0 15px #ef4444; animation: scan 2s infinite ease-in-out;
        }
        @keyframes scan { 0%, 100% { top: 10%; opacity: 0; } 50% { opacity: 1; } 100% { top: 90%; opacity: 0; } }

        /* ZOOM SLIDER */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -10px; border: 2px solid #3b82f6; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }

        /* TOAST */
        #toast {
            position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(16, 185, 129, 0.95); padding: 15px 30px; border-radius: 30px;
            color: white; font-weight: bold; font-size: 1rem; z-index: 300; display: none; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: all 0.2s; pointer-events: none;
        }
        #toast.show { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        /* LOT ETİKETİ */
        .lot-tag { background: #f59e0b; color: #000; font-weight: bold; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body class="flex flex-col h-full bg-slate-900">

    <!-- HEADER -->
    <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold text-lg"><i class="fas fa-layer-group"></i></div>
            <div>
                <h1 class="font-bold text-slate-100 text-sm tracking-wide">ARC v12 LOT-MATRIX</h1>
                <div class="text-[10px] text-green-400 font-bold flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE</div>
            </div>
        </div>
        <button onclick="openSettings()" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center text-slate-400 border border-slate-600"><i class="fas fa-cog"></i></button>
    </header>

    <!-- SAYFALAR -->
    <main class="flex-1 overflow-y-auto relative no-scrollbar pb-20 bg-slate-900">
        
        <!-- DASHBOARD -->
        <div id="page-home" class="p-4 space-y-4">
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startScanner('IN')" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition p-6 rounded-2xl border-t-4 border-emerald-500 shadow-xl flex flex-col items-center gap-3">
                    <i class="fas fa-arrow-down text-3xl text-emerald-500"></i>
                    <div class="text-center"><div class="text-lg font-bold text-white">GİRİŞ</div><div class="text-[10px] text-slate-400">Mal Kabul</div></div>
                </button>
                <button onclick="startScanner('OUT')" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition p-6 rounded-2xl border-t-4 border-rose-500 shadow-xl flex flex-col items-center gap-3">
                    <i class="fas fa-arrow-up text-3xl text-rose-500"></i>
                    <div class="text-center"><div class="text-lg font-bold text-white">ÇIKIŞ</div><div class="text-[10px] text-slate-400">Sevkiyat</div></div>
                </button>
            </div>

            <!-- ÖZET -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
                <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase flex justify-between">
                    <span>Parti (Lot) Durumu</span>
                    <span id="total-badge" class="bg-blue-900 text-blue-300 px-2 rounded text-[10px]">0 Kayıt</span>
                </h3>
                <div id="summary-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- STOKLAR -->
        <div id="page-stocks" class="hidden p-4 space-y-4">
            <input type="text" id="search-input" onkeyup="renderStocks()" placeholder="GTIN, REF, LOT veya İsim Ara..." class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none text-white focus:border-blue-500">
            <div id="stock-list" class="grid grid-cols-1 gap-3 pb-20"></div>
        </div>
    </main>

    <!-- NAVBAR -->
    <nav class="bg-slate-900 border-t border-slate-800 h-16 flex z-30">
        <button onclick="switchPage('home')" class="flex-1 flex flex-col items-center justify-center text-blue-500 nav-btn active">
            <i class="fas fa-home text-lg"></i><span class="text-[10px] font-bold mt-1">ANA EKRAN</span>
        </button>
        <button onclick="switchPage('stocks')" class="flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-slate-300 nav-btn">
            <i class="fas fa-boxes text-lg"></i><span class="text-[10px] font-bold mt-1">STOKLAR</span>
        </button>
        <button onclick="shareWhatsApp()" class="flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-slate-300 nav-btn">
            <i class="fab fa-whatsapp text-lg"></i><span class="text-[10px] font-bold mt-1">PAYLAŞ</span>
        </button>
    </nav>

    <!-- KAMERA ARAYÜZÜ -->
    <div id="scanner-container">
        <div id="reader"></div>
        <div class="scan-overlay"></div>
        <div id="focus-frame" class="focus-box"><div class="laser"></div></div>
        
        <!-- Üst Bar -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-[100]">
            <div class="bg-black/60 backdrop-blur px-3 py-1 rounded border border-white/20">
                <div class="text-[10px] text-slate-300 font-bold" id="cam-mode">MOD</div>
                <div class="text-lg font-bold text-white tracking-widest">TARANIYOR</div>
            </div>
            
            <div class="flex items-center gap-2 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/20">
                <span class="text-[10px] font-bold text-white">SERİ MOD</span>
                <input type="checkbox" id="rapid-toggle" class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            </div>

            <button onclick="stopScanner()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white"><i class="fas fa-times"></i></button>
        </div>

        <!-- Zoom -->
        <div class="absolute bottom-8 left-0 w-full px-8 z-[100]">
            <div class="bg-black/50 backdrop-blur-md rounded-xl p-3 border border-white/10">
                <div class="flex justify-between text-xs text-white/80 font-bold mb-1 font-mono"><span>1x</span><span>ZOOM</span><span>5x</span></div>
                <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" oninput="applyZoom(this.value)">
            </div>
        </div>
    </div>

    <!-- ÜRÜN İŞLEM PENCERESİ (MODAL) -->
    <div id="product-modal" class="fixed inset-0 hidden bg-black/90 backdrop-blur flex items-end sm:items-center justify-center modal-layer">
        <div class="bg-slate-800 w-full sm:w-[450px] rounded-t-3xl sm:rounded-2xl border-t border-slate-600 shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            
            <!-- Fotoğraf -->
            <div class="flex gap-4 mb-4">
                <div class="w-20 h-20 bg-slate-700 rounded-lg flex-none overflow-hidden relative border border-slate-600">
                    <img id="modal-img" src="" class="w-full h-full object-cover hidden">
                    <div id="modal-no-img" class="w-full h-full flex items-center justify-center text-slate-500"><i class="fas fa-camera text-xl"></i></div>
                    <label class="absolute inset-0 cursor-pointer flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition">
                        <i class="fas fa-camera text-white"></i>
                        <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(this)">
                    </label>
                </div>
                <div class="flex-1">
                    <label class="text-[10px] text-slate-400 font-bold">ÜRÜN ADI</label>
                    <input type="text" id="modal-name" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm outline-none focus:border-blue-500">
                    <div class="text-[10px] text-blue-400 mt-1 font-bold" id="modal-total-stock">BU PARTİDE STOK: 0</div>
                </div>
            </div>

            <!-- Detaylar (LOT AYIRIMI) -->
            <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 mb-4 grid grid-cols-2 gap-2">
                <div>
                    <label class="text-[10px] text-slate-500 font-bold">GTIN</label>
                    <div class="text-xs font-mono text-white truncate" id="modal-gtin">---</div>
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 font-bold">REF NO</label>
                    <div class="text-xs font-mono text-yellow-400 truncate font-bold" id="modal-ref">---</div>
                </div>
                <div class="col-span-2 bg-slate-800 p-1 rounded border border-yellow-600/30">
                    <label class="text-[10px] text-yellow-500 font-bold">LOT (PARTİ NO)</label>
                    <div class="text-sm font-mono text-white font-bold" id="modal-lot">---</div>
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 font-bold">SN</label>
                    <div class="text-xs font-mono text-emerald-400 truncate" id="modal-sn">---</div>
                </div>
                 <div>
                    <label class="text-[10px] text-slate-500 font-bold">SKT</label>
                    <div class="text-xs font-mono text-white truncate" id="modal-exp">---</div>
                </div>
                <div class="col-span-2">
                     <label class="text-[10px] text-slate-500 font-bold">RAF / KONUM</label>
                     <input type="text" id="modal-shelf" placeholder="A-01" class="w-full bg-slate-800 border-b border-slate-600 p-1 text-xs text-white uppercase outline-none">
                </div>
            </div>

            <button onclick="saveProduct()" id="save-btn" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-white shadow-lg mb-2">KAYDET</button>
            <button onclick="closeModal()" class="w-full py-3 text-slate-500 font-bold text-xs">İPTAL</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"><i class="fas fa-check"></i><span id="toast-text">KAYDEDİLDİ</span></div>

    <!-- AYARLAR -->
    <div id="settings-modal" class="fixed inset-0 hidden bg-black/90 backdrop-blur flex items-center justify-center modal-layer p-6">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-600">
            <h3 class="font-bold text-white mb-4">Ayarlar</h3>
            <button onclick="backupData()" class="w-full py-3 bg-blue-600 rounded-xl font-bold text-white mb-2">Yedek İndir (JSON)</button>
            <button onclick="exportExcel()" class="w-full py-3 bg-emerald-600 rounded-xl font-bold text-white mb-2">Rapor İndir (Excel)</button>
            <button onclick="resetData()" class="w-full py-3 bg-red-900/50 text-red-400 border border-red-900 rounded-xl font-bold mb-4">Verileri Sıfırla</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-full py-2 text-slate-400">Kapat</button>
        </div>
    </div>

    <script>
        // --- ARC v12 ÇEKİRDEĞİ ---
        const DB_KEY = 'arc_v12_lot_db';
        let db = { products: {} }; // Yapı: { "UNIQUE_ID": { ... } } -> UNIQUE_ID = REF + LOT
        let html5QrCode;
        let scanMode = 'IN';
        let parsedData = null;

        function init() {
            try {
                const d = localStorage.getItem(DB_KEY);
                if(d) db = JSON.parse(d);
                updateUI();
            } catch(e) { console.error(e); }
        }

        function saveDB() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                updateUI();
            } catch(e) { alert("Hafıza dolu! Lütfen 'Ayarlar'dan sıfırlama yapın."); }
        }

        // --- GS1 PARSER ---
        function parseBarcode(text) {
            let res = { raw: text, gtin: "", lot: "NOLOT", ref: "", sn: "", exp: "", uniqueId: "" };
            
            text = text.replace(/\s+/g, ' ').trim();

            if(text.includes(' ')) {
                const parts = text.split(' ');
                for(let i=0; i<parts.length; i++) {
                    let key = parts[i];
                    let val = parts[i+1];
                    if(!val) continue;

                    if(key === '01') res.gtin = val;
                    if(key === '10') res.lot = val; // LOT ÇOK ÖNEMLİ
                    if(key === '17') res.exp = val;
                    if(key === '21') res.sn = val;
                    if(key === '240') res.ref = val;
                }
            } else {
                res.sn = text; 
            }

            // *** KRİTİK DEĞİŞİKLİK: UNIQUE ID (BENZERSİZ KİMLİK) ***
            // Ürünleri birbirinden ayırmak için ID artık sadece REF değil, REF + LOT kombinasyonudur.
            // Örnek ID: "A3920_P110"
            
            let baseId = res.gtin || res.ref || "UNKNOWN";
            if(res.ref) baseId = res.ref; // Ref varsa öncelikli kullan
            
            res.uniqueId = baseId + "_" + res.lot; // Lot ile birleştir
            
            return res;
        }

        // --- KAMERA YÖNETİMİ ---
        function startScanner(mode) {
            scanMode = mode;
            document.getElementById('scanner-container').style.display = 'block';
            document.getElementById('zoom-slider').value = 1;
            
            const txt = document.getElementById('cam-mode');
            const laser = document.querySelector('.laser');
            
            if(mode === 'IN') {
                txt.innerText = "GİRİŞ MODU"; txt.className = "text-[10px] text-emerald-400 font-bold";
                laser.style.background = "#10b981"; laser.style.boxShadow = "0 0 15px #10b981";
            } else {
                txt.innerText = "ÇIKIŞ MODU"; txt.className = "text-[10px] text-rose-400 font-bold";
                laser.style.background = "#f43f5e"; laser.style.boxShadow = "0 0 15px #f43f5e";
            }

            html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 25, qrbox: {width: 250, height: 250},
                videoConstraints: { facingMode: "environment", width: { min: 1280, ideal: 1920 } }
            };

            html5QrCode.start({ facingMode: "environment" }, config, onScan)
            .catch(err => { alert("Kamera Hatası: " + err); stopScanner(); });
        }

        function stopScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').style.display = 'none';
                    html5QrCode.clear();
                }).catch(() => { document.getElementById('scanner-container').style.display = 'none'; });
            } else { document.getElementById('scanner-container').style.display = 'none'; }
        }

        function applyZoom(val) {
            if(html5QrCode) { try { html5QrCode.applyVideoConstraints({ advanced: [{ zoom: parseFloat(val) }] }); } catch(e){} }
        }

        // --- TARAMA MANTIĞI ---
        function onScan(decodedText) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type='square'; o.frequency.value=1200; g.gain.value=0.1;
                o.start(); setTimeout(()=>o.stop(), 0.1);

                parsedData = parseBarcode(decodedText);
                
                // BURADA ARTIK UNIQUE ID (REF + LOT) İLE ARIYORUZ
                const prod = db.products[parsedData.uniqueId];
                const isRapid = document.getElementById('rapid-toggle').checked;

                // SERİ MOD
                if(isRapid && prod) {
                    if(parsedData.sn) {
                        const exists = prod.logs.find(l => l.sn === parsedData.sn);
                        if(scanMode === 'IN' && exists) { showToast("MÜKERRER!", "bg-red-600"); return; }
                        if(scanMode === 'OUT' && !exists) { showToast("STOKTA YOK!", "bg-red-600"); return; }
                    }

                    const entry = { sn: parsedData.sn, lot: parsedData.lot, ref: parsedData.ref || prod.ref, date: new Date().toLocaleString(), type: scanMode };
                    if(scanMode === 'IN') { prod.logs.push(entry); prod.totalQty++; }
                    else { prod.logs.push(entry); prod.totalQty = Math.max(0, prod.totalQty - 1); }
                    
                    saveDB();
                    showToast(prod.name + (scanMode==='IN' ? " (+1)" : " (-1)"));
                    return; 
                }

                // NORMAL MOD
                html5QrCode.pause(); 
                
                if(prod && parsedData.sn) {
                    const exists = prod.logs.find(l => l.sn === parsedData.sn);
                    if(scanMode === 'IN' && exists) { alert("BU ÜRÜN (BU LOTTA) ZATEN OKUTULDU!\nSN: " + parsedData.sn); html5QrCode.resume(); return; }
                    if(scanMode === 'OUT' && !exists) { alert("BU ÜRÜN BU LOTTA YOK!\nSN: " + parsedData.sn); html5QrCode.resume(); return; }
                }

                // Yeni ürün veya yeni lot ise -> Modal açılır
                // İsim arama (Farklı lotta aynı ürün ismi varsa otomatik doldur)
                let suggestedName = "";
                if(!prod) {
                    const similarProd = Object.values(db.products).find(p => p.ref === parsedData.ref);
                    if(similarProd) suggestedName = similarProd.name;
                }

                openModal(parsedData, prod, suggestedName);

            } catch(e) {
                alert("Okuma Hatası: " + e);
                html5QrCode.resume();
            }
        }

        // --- MODAL ---
        function openModal(data, prod, suggestedName) {
            document.getElementById('modal-gtin').innerText = data.gtin || "---";
            document.getElementById('modal-lot').innerText = data.lot || "---";
            document.getElementById('modal-sn').innerText = data.sn || "---";
            document.getElementById('modal-ref').innerText = data.ref || (prod ? prod.ref : "---");
            document.getElementById('modal-exp').innerText = data.exp || "---";

            const nameInp = document.getElementById('modal-name');
            const shelfInp = document.getElementById('modal-shelf');
            const img = document.getElementById('modal-img');
            const noImg = document.getElementById('modal-no-img');

            if(prod) {
                nameInp.value = prod.name;
                shelfInp.value = prod.shelf || "";
                document.getElementById('modal-total-stock').innerText = "BU PARTİ STOK: " + prod.totalQty;
                if(prod.image) { img.src = prod.image; img.classList.remove('hidden'); noImg.classList.add('hidden'); }
                else { img.classList.add('hidden'); noImg.classList.remove('hidden'); }
            } else {
                nameInp.value = suggestedName || ""; // Eğer başka lotta varsa ismini getir
                shelfInp.value = "";
                document.getElementById('modal-total-stock').innerText = "YENİ PARTİ (LOT)";
                img.classList.add('hidden'); noImg.classList.remove('hidden');
            }

            const btn = document.getElementById('save-btn');
            if(scanMode === 'IN') { btn.innerText = "KAYDET (GİRİŞ)"; btn.className = "w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white shadow-lg mb-2"; }
            else { btn.innerText = "KAYDET (ÇIKIŞ)"; btn.className = "w-full py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-white shadow-lg mb-2"; }

            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('product-modal').classList.add('hidden'); html5QrCode.resume(); }

        function saveProduct() {
            try {
                const name = document.getElementById('modal-name').value || ("Ürün " + parsedData.id);
                const shelf = document.getElementById('modal-shelf').value.toUpperCase();
                const ref = document.getElementById('modal-ref').innerText;
                const imgEl = document.getElementById('modal-img');
                const imgSrc = (!imgEl.classList.contains('hidden')) ? imgEl.src : null;

                // Veritabanı anahtarı artık UNIQUE ID (REF+LOT)
                if(!db.products[parsedData.uniqueId]) {
                    db.products[parsedData.uniqueId] = { 
                        id: parsedData.uniqueId, // Benzersiz ID
                        name: name, shelf: shelf, ref: ref, lot: parsedData.lot, image: imgSrc, totalQty: 0, logs: [] 
                    };
                }
                let prod = db.products[parsedData.uniqueId];
                prod.name = name; prod.shelf = shelf; 
                if(ref !== "---") prod.ref = ref;
                if(imgSrc) prod.image = imgSrc;

                const entry = { sn: parsedData.sn, lot: parsedData.lot, ref: prod.ref, date: new Date().toLocaleString(), type: scanMode };
                
                if(scanMode === 'IN') { prod.logs.push(entry); prod.totalQty++; }
                else { prod.logs.push(entry); prod.totalQty = Math.max(0, prod.totalQty - 1); }

                saveDB();
                document.getElementById('product-modal').classList.add('hidden');
                stopScanner();
                showToast("KAYDEDİLDİ");
            } catch(e) { alert("Kayıt Hatası: " + e); }
        }

        function handlePhoto(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = function() {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const sc = 300 / i.width; c.width = 300; c.height = i.height * sc;
                        ctx.drawImage(i, 0, 0, c.width, c.height);
                        document.getElementById('modal-img').src = c.toDataURL('image/jpeg', 0.6);
                        document.getElementById('modal-img').classList.remove('hidden');
                        document.getElementById('modal-no-img').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- UI ---
        function updateUI() {
            const list = document.getElementById('summary-list');
            const arr = Object.values(db.products);
            document.getElementById('total-badge').innerText = arr.length + " Parti";
            
            if(arr.length === 0) { list.innerHTML = '<div class="text-center text-xs text-slate-500">Veri Yok</div>'; return; }

            list.innerHTML = arr.map(p => `
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-800 rounded flex-none overflow-hidden">
                            ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-slate-600"><i class="fas fa-barcode"></i></div>`}
                        </div>
                        <div class="overflow-hidden">
                            <div class="text-xs font-bold text-white truncate w-32">${p.name}</div>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-blue-900 text-blue-200 px-1 rounded">R: ${p.ref}</span>
                                <span class="text-[10px] bg-yellow-900 text-yellow-200 px-1 rounded">L: ${p.lot}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-lg font-bold ${p.totalQty > 0 ? 'text-blue-400' : 'text-red-500'}">${p.totalQty}</div>
                </div>
            `).join('');
            
            renderStocks();
        }

        function renderStocks() {
            const grid = document.getElementById('stock-list'); if(!grid) return;
            const term = document.getElementById('search-input').value.toLowerCase();
            const arr = Object.values(db.products).filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.lot.toLowerCase().includes(term) ||
                (p.ref && p.ref.toLowerCase().includes(term))
            );
            
            grid.innerHTML = arr.map(p => `
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <div class="p-3 border-b border-slate-700 flex justify-between bg-slate-800 items-center">
                        <div>
                            <span class="font-bold text-sm text-white block">${p.name}</span>
                            <div class="flex gap-2 mt-1">
                                <span class="lot-tag">LOT: ${p.lot}</span>
                                <span class="text-[10px] text-slate-400 font-bold self-center">REF: ${p.ref}</span>
                            </div>
                        </div>
                        <span class="font-bold text-blue-400 text-lg">${p.totalQty}</span>
                    </div>
                    <div class="max-h-32 overflow-y-auto bg-slate-900 p-2">
                        <table class="w-full text-[10px] text-left text-slate-400">
                            <thead><tr><th>SN</th><th>LOT</th><th>TÜR</th></tr></thead>
                            <tbody>${p.logs.slice().reverse().map(l => `<tr class="border-b border-slate-800"><td class="py-1 font-mono text-white">${l.sn}</td><td>${l.lot}</td><td class="${l.type==='IN'?'text-emerald-500':'text-rose-500'} font-bold">${l.type==='IN'?'GİRİŞ':'ÇIKIŞ'}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        function showToast(msg = "KAYDEDİLDİ", bgClass = "bg-emerald-600") {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = msg;
            t.className = ""; t.classList.add(bgClass.replace('bg-', '')); 
            t.style.backgroundColor = bgClass === "bg-red-600" ? "rgba(220, 38, 38, 0.9)" : "rgba(16, 185, 129, 0.9)";
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }

        function resetData() { if(confirm("Tüm veriler silinecek!")) { localStorage.removeItem(DB_KEY); db = { products: {} }; updateUI(); } }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function switchPage(page) {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active', 'text-blue-500'));
            if(page === 'home') { document.getElementById('page-home').classList.remove('hidden'); document.querySelectorAll('.nav-btn')[0].classList.add('active', 'text-blue-500'); }
            if(page === 'stocks') { document.getElementById('page-stocks').classList.remove('hidden'); document.querySelectorAll('.nav-btn')[1].classList.add('active', 'text-blue-500'); renderStocks(); }
        }
        function backupData() {
            const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = d; a.download = 'ARC_Yedek.json'; a.click();
        }
        function exportExcel() {
            let csv = "GTIN;URUN;REF;LOT;RAF;ISLEM;SN;TARIH\n";
            Object.values(db.products).forEach(p => { p.logs.forEach(l => { csv += `${p.id};${p.name};${p.ref};${p.lot};${p.shelf};${l.type};${l.sn};${l.date}\n`; }); });
            const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'Rapor.csv'; a.click();
        }
        function shareWhatsApp() {
             let msg = "ARC STOK RAPORU:\n";
             Object.values(db.products).forEach(p => { msg += `${p.name} (Lot:${p.lot}): ${p.totalQty} Adet\n`; });
             window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        init();
    </script>
</body>
</html>

