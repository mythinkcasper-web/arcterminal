<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stok Terminal Pro V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f1f5f9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none; /* Metin seçimini engelle (hız için) */
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Listeleme Alanı Scroll */
        #inventory-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        /* Kart Stilleri */
        .item-card {
            transition: transform 0.1s, background-color 0.2s;
            border-left: 5px solid #475569; /* Varsayılan Gri */
        }
        
        .item-card:active { transform: scale(0.98); }

        /* Durum Renkleri */
        .status-ok { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.08); } /* Yeşil */
        .status-error { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.15); } /* Kırmızı/Fazla */
        .status-process { border-left-color: #eab308; background: rgba(234, 179, 8, 0.05); } /* Sarı/Devam */
        
        /* Son Okunan Vurgusu */
        .last-scanned {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
            z-index: 10;
        }

        /* Input Alanı */
        .scanner-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
        }

        .modal-bg { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <!-- ÜST BAR: Özet Bilgi -->
    <header class="bg-slate-800 border-b border-slate-700 p-3 shadow-xl z-30 flex flex-col gap-2">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-barcode text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-white font-bold text-lg leading-none tracking-tight">STOK MİZAN</h1>
                    <div class="text-[10px] text-slate-400 font-mono mt-1">TERMİNAL MODU</div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- CSV Yükle Butonu -->
                <button onclick="document.getElementById('csvInput').click()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-2 rounded-lg text-xs font-bold border border-slate-600 transition flex items-center gap-2">
                    <i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline">Liste Yükle</span>
                </button>
                <!-- Rapor Al Butonu -->
                <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-green-900/20 transition flex items-center gap-2">
                    <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Rapor</span>
                </button>
            </div>
        </div>

        <!-- İstatistik Çubuğu -->
        <div class="flex rounded-md overflow-hidden text-center text-xs font-mono font-bold border border-slate-700">
            <div class="bg-slate-900 text-slate-400 py-1.5 flex-1 border-r border-slate-700">
                TOPLAM: <span id="stat-total" class="text-white text-sm">0</span>
            </div>
            <div class="bg-slate-900 text-slate-400 py-1.5 flex-1 border-r border-slate-700">
                SAYILAN: <span id="stat-counted" class="text-yellow-400 text-sm">0</span>
            </div>
            <div class="bg-slate-900 text-slate-400 py-1.5 flex-1">
                KALAN: <span id="stat-remaining" class="text-red-400 text-sm">0</span>
            </div>
        </div>
    </header>

    <!-- SCANNER ALANI (SABİT) -->
    <div class="p-3 bg-slate-800/95 backdrop-blur border-b border-slate-700 sticky top-0 z-20 shadow-lg">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-qrcode text-slate-500 text-xl"></i>
            </div>
            <input 
                type="text" 
                id="barcodeInput" 
                placeholder="Barkodu okut..." 
                class="scanner-input w-full bg-slate-900 text-white text-xl font-mono pl-10 pr-4 py-3 rounded-xl border border-slate-600 outline-none transition-all placeholder-slate-600"
                autocomplete="off"
                spellcheck="false"
            >
            <div class="absolute inset-y-0 right-2 flex items-center">
                 <button onclick="clearInput()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                 </button>
            </div>
        </div>
        <!-- Durum Mesajı -->
        <div id="status-msg" class="text-center text-xs font-bold mt-1 h-4 text-slate-500 transition-colors">Hazır, bekliyor...</div>
    </div>

    <!-- LİSTE ALANI -->
    <main id="inventory-container" class="flex-1 overflow-y-auto p-2 bg-slate-900 pb-24">
        <!-- JS ile dolacak -->
    </main>

    <!-- MANUEL GİRİŞ BUTONU (MOBİL) -->
    <button onclick="focusInput()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full shadow-2xl shadow-blue-500/50 flex items-center justify-center text-white z-40 md:hidden active:scale-90 transition-transform">
        <i class="fa-solid fa-keyboard text-xl"></i>
    </button>

    <!-- GİZLİ INPUT -->
    <input type="file" id="csvInput" class="hidden" accept=".csv" onchange="handleFileUpload(this)">

    <!-- MODAL: EŞLEŞTİRME -->
    <div id="link-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-700 bg-slate-800 rounded-t-2xl">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-link text-yellow-500"></i> Barkod Tanımla
                    </h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="bg-slate-900 p-3 rounded border border-slate-700 text-center mb-4">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider">OKUNAN BARKOD</div>
                    <div id="modal-barcode-display" class="text-2xl font-bold text-white mono mt-1 select-all"></div>
                </div>

                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-500"></i>
                    <input type="text" id="modal-search" placeholder="Stok Kodu veya İsim Ara..." class="w-full bg-slate-900 border border-slate-600 rounded-lg pl-10 p-3 text-white focus:border-blue-500 outline-none">
                </div>
            </div>
            
            <div id="modal-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-900">
                <!-- Arama sonuçları -->
            </div>
        </div>
    </div>

    <script>
        // --- SES EFEKTLERİ ---
        const playBeep = (type) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            if(type === 'success') { // İnce Bip
                osc.type = 'sine';
                osc.frequency.value = 1000;
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } else if(type === 'error') { // Kalın Düt
                osc.type = 'sawtooth';
                osc.frequency.value = 200;
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } else if(type === 'complete') { // Çift Bip
                osc.type = 'square';
                osc.frequency.value = 800;
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                osc.start();
                setTimeout(() => osc.frequency.value = 1200, 100);
                osc.stop(ctx.currentTime + 0.2);
            }
        };

        // --- GÖMÜLÜ VERİ (SENİN LİSTEN) ---
        const embeddedData = [
            {code:"MH-013",name:"ALKALİN FOSFATAZ (ALP ) (280 TEST)",target:4,date:"05.08.2027",lot:"017",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-102",name:"LDL KOLESTEROL (280 TEST)",target:2,date:"18.12.2026",lot:"053",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-213",name:"LİPAZ (282 TEST)",target:1,date:"18.05.2027",lot:"009",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-343",name:"CRP TURBİ WR (310 TEST)",target:3,date:"06.08.2026",lot:"406",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-363",name:"RF TÜRBİDİMETRİK (282 TEST)",target:2,date:"21.04.2027",lot:"886",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-483",name:"LDH DGKC (216 TEST)",target:2,date:"30.08.2028",lot:"810",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"VT-010",name:"SPESİFİK PROTEİN KONTROL SEVİYE 2( 5 x 1 mL )",target:5,date:"15.10.2027",lot:"019",loc:"Sevkiyat Depo | G | 11 | 1"},
            {code:"MH-222",name:"MAGNEZYUM (700 TEST)",target:1,date:"03.03.2028",lot:"324",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-272",name:"TRİGLİSERİT (884 TEST)",target:5,date:"25.10.2026",lot:"300",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-282",name:"UIBC (350 TEST)",target:1,date:"01.04.2027",lot:"907",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-302",name:"ÜRİK ASİT (350 TEST)",target:11,date:"29.03.2027",lot:"842",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-442",name:"SODYUM (230 TEST)",target:2,date:"30.03.2026",lot:"012",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-462",name:"KLORÜR (236 TEST)",target:1,date:"30.03.2030",lot:"756",loc:"Sevkiyat Depo | G | 15 | 1"},
            {code:"MH-482",name:"LDH DGKC (326 TEST)",target:1,date:"30.08.2028",lot:"810",loc:"Sevkiyat Depo | G | 15 | 1"}
        ];

        // --- STATE ---
        let inventory = [];
        let barcodeMap = {}; // EAN -> StockCode
        let lastScanned = null;
        let tempBarcode = "";

        // --- BAŞLANGIÇ ---
        function init() {
            // Kayıtlı veri var mı?
            const savedInv = localStorage.getItem('stok_v5_data');
            const savedMap = localStorage.getItem('stok_v5_map');

            if(savedInv) {
                inventory = JSON.parse(savedInv);
            } else {
                // Yoksa gömülü veriyi kullan (Count'ları sıfırla)
                inventory = embeddedData.map(i => ({...i, count: 0}));
            }

            if(savedMap) {
                barcodeMap = JSON.parse(savedMap);
            }

            renderInventory();
            updateStats();
            focusInput();
            
            // Focus Koruma
            document.addEventListener('click', (e) => {
                if(!e.target.closest('input') && !e.target.closest('button') && document.getElementById('link-modal').classList.contains('hidden')) {
                    focusInput();
                }
            });
        }

        // --- DOSYA YÜKLEME ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Başlık satırını atla, veriyi parse et
                // Beklenen Format: Stok Kodu;Stok İsim;Kalan Miktar;Son Kullanma Tarihi;LOT;Depo Adres
                const newInv = [];
                
                for(let i=1; i<lines.length; i++) {
                    const line = lines[i].trim();
                    if(!line) continue;
                    
                    const cols = line.split(';'); // NOKTALI VİRGÜL AYIRACI
                    if(cols.length < 3) continue;

                    newInv.push({
                        code: cols[0]?.trim(),
                        name: cols[1]?.trim(),
                        target: parseInt(cols[2]?.trim()) || 0,
                        date: cols[3]?.trim() || '-',
                        lot: cols[4]?.trim() || '-',
                        loc: cols[5]?.trim() || '-'
                    });
                }

                if(newInv.length > 0) {
                    if(confirm(`${newInv.length} ürün bulundu. Mevcut liste silinip bu yüklensin mi?`)) {
                        inventory = newInv.map(i => ({...i, count: 0}));
                        lastScanned = null;
                        saveData();
                        renderInventory();
                        updateStats();
                        alert("Liste başarıyla yüklendi!");
                    }
                } else {
                    alert("Hata: Dosya formatı uygun değil. Noktalı virgül (;) kullanıldığından emin ol.");
                }
            };
            reader.readAsText(file, "UTF-8");
        }

        // --- RENDER ---
        function renderInventory() {
            const container = document.getElementById('inventory-container');
            container.innerHTML = '';

            // Sıralama: Son Okunan > Eksikler > Tamamlananlar
            const sorted = [...inventory].sort((a, b) => {
                if(a.code === lastScanned) return -1;
                if(b.code === lastScanned) return 1;
                
                const aDone = a.count >= a.target;
                const bDone = b.count >= b.target;
                if(aDone === bDone) return 0;
                return aDone ? 1 : -1;
            });

            // Performans için ilk 50 öğe (Sanal scroll yok ama yeterli)
            const displayList = sorted.slice(0, 100);

            displayList.forEach(item => {
                const isMatch = item.count === item.target;
                const isOver = item.count > item.target;
                const isProcess = item.count > 0 && !isMatch;
                const isLast = item.code === lastScanned;

                let statusClass = '';
                let iconClass = 'fa-regular fa-circle text-slate-600';
                let countColor = 'text-slate-400';

                if(isOver) {
                    statusClass = 'status-error';
                    iconClass = 'fa-solid fa-triangle-exclamation text-red-500';
                    countColor = 'text-red-500';
                } else if(isMatch) {
                    statusClass = 'status-ok';
                    iconClass = 'fa-solid fa-circle-check text-green-500';
                    countColor = 'text-green-500';
                } else if(isProcess) {
                    statusClass = 'status-process';
                    iconClass = 'fa-solid fa-spinner fa-spin text-yellow-500';
                    countColor = 'text-yellow-400';
                }

                const html = `
                    <div id="row-${item.code}" class="item-card relative bg-slate-800 rounded-lg p-3 mb-2 shadow-sm ${statusClass} ${isLast ? 'last-scanned' : ''}">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 overflow-hidden">
                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                    <span class="bg-slate-900 text-blue-400 px-2 py-0.5 rounded text-sm font-mono font-bold border border-slate-700">${item.code}</span>
                                    <span class="text-[10px] text-slate-400 border border-slate-700 px-1.5 py-0.5 rounded bg-slate-900/50 flex items-center gap-1">
                                        <i class="fa-solid fa-layer-group text-[9px]"></i> ${item.lot}
                                    </span>
                                    <span class="text-[10px] text-slate-400 border border-slate-700 px-1.5 py-0.5 rounded bg-slate-900/50 flex items-center gap-1">
                                        <i class="fa-solid fa-calendar text-[9px]"></i> ${item.date}
                                    </span>
                                </div>
                                <h4 class="text-slate-200 font-semibold text-sm leading-snug truncate" title="${item.name}">${item.name}</h4>
                                <div class="mt-1 text-xs text-slate-400 flex items-center gap-1">
                                    <i class="fa-solid fa-location-dot text-slate-500"></i> ${item.loc}
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-end gap-1 min-w-[60px]">
                                <div class="text-2xl font-bold mono leading-none flex items-baseline gap-1">
                                    <span class="${countColor}">${item.count}</span>
                                    <span class="text-xs text-slate-600">/${item.target}</span>
                                </div>
                                <div class="mt-1">${item.code === lastScanned ? '<span class="text-[10px] font-bold text-blue-500 animate-pulse">OKUNDU</span>' : `<i class="${iconClass}"></i>`}</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-700/50">
                            <button onclick="updateCount('${item.code}', -1)" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-xs font-bold transition border border-slate-600">-1</button>
                            <button onclick="updateCount('${item.code}', 1)" class="px-5 py-1 bg-blue-600 hover:bg-blue-500 rounded text-white text-xs font-bold shadow-lg shadow-blue-500/20 transition">+1 EKLE</button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- BARKOD İŞLEME ---
        const inputEl = document.getElementById('barcodeInput');

        inputEl.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const val = inputEl.value.trim().toUpperCase();
                if(val) processScan(val);
                inputEl.value = '';
            }
        });

        function focusInput() { inputEl.focus(); }
        function clearInput() { inputEl.value = ''; focusInput(); }

        function processScan(scan) {
            // 1. Eşleşme kontrolü
            let target = barcodeMap[scan];
            
            // 2. Direkt stok kodu mu?
            if(!target) {
                const direct = inventory.find(i => i.code === scan);
                if(direct) target = scan;
            }

            if(target) {
                updateCount(target, 1);
            } else {
                // Bilinmeyen Barkod
                playBeep('error');
                tempBarcode = scan;
                openModal();
            }
        }

        function updateCount(code, amount) {
            const idx = inventory.findIndex(i => i.code === code);
            if(idx === -1) return;

            const item = inventory[idx];
            const newVal = Math.max(0, item.count + amount);
            
            inventory[idx].count = newVal;
            lastScanned = code;

            // Bildirim & Ses
            const msgEl = document.getElementById('status-msg');
            if(amount > 0) {
                if(newVal > item.target) {
                    playBeep('error');
                    msgEl.innerHTML = `<span class="text-red-500">FAZLA: ${item.name}</span>`;
                } else if(newVal === item.target) {
                    playBeep('complete');
                    msgEl.innerHTML = `<span class="text-green-500">TAMAMLANDI: ${item.name}</span>`;
                } else {
                    playBeep('success');
                    msgEl.innerHTML = `<span class="text-blue-400">OKUNDU: ${item.name}</span>`;
                }
            } else {
                msgEl.innerText = "Adet düşüldü.";
            }

            saveData();
            renderInventory();
            updateStats();

            // Scroll focus
            setTimeout(() => {
                const el = document.getElementById(`row-${code}`);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 50);
        }

        // --- İSTATİSTİK ---
        function updateStats() {
            const total = inventory.reduce((a, b) => a + b.target, 0);
            const counted = inventory.reduce((a, b) => a + b.count, 0);
            const remaining = Math.max(0, total - counted);

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-counted').innerText = counted;
            document.getElementById('stat-remaining').innerText = remaining;
        }

        function saveData() {
            localStorage.setItem('stok_v5_data', JSON.stringify(inventory));
            localStorage.setItem('stok_v5_map', JSON.stringify(barcodeMap));
        }

        // --- MODAL ---
        const modal = document.getElementById('link-modal');
        const modalList = document.getElementById('modal-list');
        const modalSearch = document.getElementById('modal-search');

        function openModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('modal-barcode-display').innerText = tempBarcode;
            renderModalList('');
            modalSearch.focus();
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            tempBarcode = '';
            focusInput();
        }

        function renderModalList(term) {
            modalList.innerHTML = '';
            const filtered = inventory.filter(i => 
                i.name.toLowerCase().includes(term.toLowerCase()) || 
                i.code.toLowerCase().includes(term.toLowerCase())
            );

            if(filtered.length === 0) {
                modalList.innerHTML = '<div class="text-center text-slate-500 py-4">Ürün bulunamadı.</div>';
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-slate-700/50 p-3 rounded border border-slate-600 flex justify-between items-center cursor-pointer hover:bg-slate-600 transition mb-2";
                div.innerHTML = `
                    <div>
                        <div class="text-white font-bold text-sm">${item.name}</div>
                        <div class="text-xs text-blue-300 font-mono">${item.code}</div>
                    </div>
                    <i class="fa-solid fa-link text-white/50"></i>
                `;
                div.onclick = () => {
                    barcodeMap[tempBarcode] = item.code;
                    closeModal();
                    updateCount(item.code, 1);
                    alert(`BAŞARILI: ${tempBarcode} artık ${item.code} olarak tanınacak.`);
                };
                modalList.appendChild(div);
            });
        }

        modalSearch.addEventListener('input', (e) => renderModalList(e.target.value));

        // --- EXPORT CSV ---
        function exportCSV() {
            let csv = "\uFEFFStok Kodu;Stok İsim;Hedef;Sayılan;Durum;Raf;LOT;SKT\n";
            inventory.forEach(i => {
                let status = i.count === i.target ? "TAMAM" : (i.count > i.target ? "FAZLA" : "EKSİK");
                csv += `${i.code};"${i.name}";${i.target};${i.count};${status};"${i.loc}";"${i.lot}";"${i.date}"\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sayim_Sonuc_${new Date().toLocaleDateString()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Başlat
        init();

    </script>
</body>
</html>

